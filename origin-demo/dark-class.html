<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./dark-class.css" />
  </head>
  <body>
    <h2>åŸç”Ÿæ¢è‚¤æ–¹æ¡ˆ-é€šè¿‡classåˆ‡æ¢</h2>
    <script>
      // è·å–ä¸»é¢˜åå¥½
      const getThemePreference = () => {
        const currentTheme = localStorage.getItem('theme')
        if (currentTheme) return currentTheme
        return window.matchMedia('(prefers-color-scheme:dark)').matches ? 'dark' : 'light'
      }
      // åº”ç”¨ä¸»é¢˜(é€šè¿‡classåˆ‡æ¢)
      const applyTheme = (theme) => {
        const rootEl = document.documentElement
        theme === 'dark' ? rootEl.classList.add('dark') : rootEl.classList.remove('dark')
      }
      // åˆå§‹åŒ–ä¸»é¢˜
      const initTheme = () => {
        const theme = getThemePreference()
        applyTheme(theme)

        // åˆ›å»ºåˆ‡æ¢æŒ‰é’®
        const toggleBtn = document.createElement('button')
        toggleBtn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'
        toggleBtn.classList.add('theme-toggle-btn')
        // æ‰‹åŠ¨åˆ‡æ¢é€»è¾‘
        toggleBtn.addEventListener('click', (event) => {
          // const rootEl = document.documentElement
          // const currentTheme = rootEl.classList.contains('dark') ? 'dark' : 'light'
          const currentTheme = getThemePreference()
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark'
          localStorage.setItem('theme', newTheme)
          // applyTheme(newTheme)
          toggleBtn.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'

          // æ·»åŠ åŠåœ†è¿‡æ¸¡èƒŒæ™¯è‰²æ•ˆæœ
          // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ View Transition API
          if (!document.startViewTransition) {
            // ä¸æ”¯æŒåˆ™ç›´æ¥åˆ‡æ¢ä¸»é¢˜ï¼Œä¸æ·»åŠ åŠ¨ç”»
            document.documentElement.classList.toggle('dark')
            return
          }
          const transition = document.startViewTransition(() => {
            document.documentElement.classList.toggle('dark')
          })
          transition.ready.then(() => {
            const { clientX, clientY } = event
            const endRadius = Math.hypot(
              Math.max(clientX, innerWidth - clientX),
              Math.max(clientY, innerHeight - clientY)
            )
            const clipPath = [
              `circle(0px at ${clientX}px ${clientY}px)`,
              `circle(${endRadius}px at ${clientX}px ${clientY}px)`
            ]
            const isDark = document.documentElement.classList.contains('dark')
            document.documentElement.animate(
              {
                clipPath: isDark ? clipPath.reverse() : clipPath
              },
              {
                duration: 450,
                easing: 'ease-in',
                pseudoElement: isDark
                  ? '::view-transition-old(root)'
                  : '::view-transition-new(root)'
              }
            )
          })
        })

        document.body.appendChild(toggleBtn)

        // ç›‘å¬ç³»ç»Ÿä¸»é¢˜çš„å˜åŒ– -- é¦–æ¬¡åŠ è½½ï¼Œæ²¡ç»è¿‡æ‰‹åŠ¨åˆ‡æ¢éœ€è¦è¿›è¡Œç›‘å¬
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
          if (!localStorage.getItem('theme')) {
            applyTheme(e.matches ? 'dark' : 'light')
            toggleBtn.textContent = e.matches ? 'â˜€ï¸' : 'ğŸŒ™'
          }
        })
      }

      window.addEventListener('DOMContentLoaded', initTheme)
    </script>
  </body>
</html>
